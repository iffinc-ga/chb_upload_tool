<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manki Invoice Parser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }
        
        /* Upload Screen */
        .upload-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .upload-container { max-width: 600px; width: 100%; background: white; border-radius: 12px; box-shadow: 0 2px 20px rgba(0,0,0,0.1); padding: 40px; text-align: center; }
        .upload-container h1 { color: #667eea; margin-bottom: 10px; font-size: 32px; }
        .upload-container p { color: #6b7280; margin-bottom: 30px; }
        .upload-area { border: 3px dashed #d1d5db; border-radius: 8px; padding: 60px 20px; cursor: pointer; transition: all 0.3s; }
        .upload-area:hover { border-color: #667eea; background: #f9fafb; }
        .upload-area.dragover { border-color: #667eea; background: #eef2ff; }
        .upload-icon { font-size: 48px; margin-bottom: 20px; }
        .upload-text { font-size: 18px; color: #374151; margin-bottom: 10px; }
        .upload-subtext { font-size: 14px; color: #9ca3af; }
        input[type="file"] { display: none; }
        
        /* Editor Screen */
        .editor-screen { display: none; }
        .container { max-width: 1600px; margin: 0 auto; background: white; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }
        .header h1 { margin-bottom: 10px; font-size: 28px; }
        .header .actions { margin-top: 15px; display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-light { background: white; color: #667eea; }
        .btn-light:hover { background: #f9fafb; }
        
        .controls { padding: 20px 30px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 102; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        label { font-weight: 600; color: #374151; font-size: 14px; }
        select, input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
        select { min-width: 300px; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: #f59e0b; color: white; padding: 4px 8px; font-size: 12px; margin: 0 2px; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; padding: 4px 8px; font-size: 12px; }
        .btn-danger:hover { background: #dc2626; }
        
        .stats { padding: 20px 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #fef3c7; border-bottom: 1px solid #fbbf24; position: sticky; top: 75px; z-index: 101; }
        .stat { padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #f59e0b; }
        .stat-label { font-size: 12px; color: #6b7280; text-transform: uppercase; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #1f2937; }
        .stat-value input { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 18px; font-weight: bold; }
        .stat-value.small { font-size: 16px; }
        .stat-value.error { color: #ef4444; }
        .stat-value.success { color: #10b981; }
        .stat-value.readonly { font-size: 24px; }
        
        .table-container { padding: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { background: #f3f4f6; padding: 12px 8px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; position: sticky; top: 250px; font-size: 13px; z-index: 100; }
        td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f9fafb; }
        td input { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; }
        td input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .error-cell { background: #fee2e2; }
        .error-cell input { border-color: #ef4444; }
        .readonly { background: #f9fafb; color: #6b7280; }
        .actions-cell { text-align: center; white-space: nowrap; }
        
        .alert { padding: 15px; margin: 20px 30px; border-radius: 8px; display: none; }
        .alert.success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .alert.error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .alert.info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
        
        .editable-label { display: inline-block; padding: 2px 6px; background: #dbeafe; border-radius: 4px; font-size: 10px; color: #1e40af; margin-left: 5px; }
        
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .loading-spinner { border: 4px solid #f3f4f6; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Upload Screen -->
    <div class="upload-screen" id="uploadScreen">
        <div class="upload-container">
            <h1>üìã Manki Invoice Parser</h1>
            <p>Parse Mankiewicz customs invoice PDFs instantly in your browser</p>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Click to upload or drag & drop</div>
                <div class="upload-subtext">Mankiewicz customs invoice PDF</div>
            </div>
            
            <input type="file" id="fileInput" accept=".pdf">
        </div>
    </div>

    <!-- Editor Screen -->
    <div class="editor-screen" id="editorScreen">
        <div class="container">
            <div class="header">
                <h1>üìã Manki Invoice Parser</h1>
                <p id="fileName">Processing...</p>
                <div class="actions">
                    <button class="btn btn-light" onclick="resetParser()">‚Üê Upload New PDF</button>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label for="invoiceSelect">Filter by Invoice:</label>
                    <select id="invoiceSelect">
                        <option value="">All Invoices</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Invoice Number</div>
                    <div class="stat-value readonly" id="statInvoice">-</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Invoice Date <span class="editable-label">EDITABLE</span></div>
                    <div class="stat-value">
                        <input type="text" id="invoiceDateInput" placeholder="MM/DD/YYYY">
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">Supplier Name <span class="editable-label">EDITABLE</span></div>
                    <div class="stat-value small">
                        <input type="text" id="supplierInput" placeholder="Enter supplier name">
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">Invoice Total <span class="editable-label">EDITABLE</span></div>
                    <div class="stat-value">
                        <input type="number" step="0.01" id="invoiceTotalInput" placeholder="0.00">
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">Line Items Sum</div>
                    <div class="stat-value" id="statSum">$0.00</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Difference</div>
                    <div class="stat-value" id="statDiff">$0.00</div>
                </div>
            </div>
            
            <div class="alert" id="alert"></div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">Pos</th>
                            <th style="width: 100px;">Part Number</th>
                            <th style="width: 100px;">Quantity</th>
                            <th style="width: 80px;">Unit</th>
                            <th style="width: 120px;">Unit Price</th>
                            <th style="width: 120px;">Line Total</th>
                            <th style="width: 100px;">Calc Total</th>
                            <th style="width: 100px;">Net Weight</th>
                            <th style="width: 80px;">Country</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" class="loading">
                                <div class="loading-spinner"></div>
                                <div>Parsing PDF...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        let allData = [];
        let currentInvoice = '';
        let currentFileName = '';
        
        // Upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                processPDF(file);
            } else {
                alert('Please upload a PDF file');
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processPDF(file);
            }
        });
        
        async function processPDF(file) {
            currentFileName = file.name;
            document.getElementById('uploadScreen').style.display = 'none';
            document.getElementById('editorScreen').style.display = 'block';
            document.getElementById('fileName').textContent = `Processing: ${file.name}`;
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                parseInvoiceText(fullText);
                document.getElementById('fileName').textContent = `${file.name} - ${allData.length} line items parsed`;
                
            } catch (error) {
                console.error('Error processing PDF:', error);
                showAlert('Error processing PDF. Please make sure it\'s a valid Mankiewicz customs invoice.', 'error');
            }
        }
        
        function parseInvoiceText(text) {
            const lines = text.split('\n');
            const invoiceData = {};
            allData = [];
            
            let currentInvoiceNum = null;
            
            // First pass: collect invoice metadata
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Invoice number
                const invMatch = line.match(/Customs Invoice\s+(\d+)/);
                if (invMatch) {
                    currentInvoiceNum = invMatch[1];
                    if (!invoiceData[currentInvoiceNum]) {
                        invoiceData[currentInvoiceNum] = { date: '', supplier: '', total: '' };
                    }
                    
                    // Look for date
                    const dateMatch = lines[i + 1]?.match(/from\s+(\d{2}\/\d{2}\/\d{4})/);
                    if (dateMatch) {
                        invoiceData[currentInvoiceNum].date = dateMatch[1];
                    }
                }
                
                // Supplier
                if ((line.includes('GmbH') || line.includes('LLC')) && !line.includes('Mankiew') && currentInvoiceNum) {
                    if (!invoiceData[currentInvoiceNum].supplier) {
                        invoiceData[currentInvoiceNum].supplier = line.split(',')[0].trim();
                    }
                }
                
                // Invoice total
                const totalMatch = line.match(/Overall amount in USD\s+([\d,]+\.?\d*)/);
                if (totalMatch && currentInvoiceNum) {
                    invoiceData[currentInvoiceNum].total = totalMatch[1].replace(/,/g, '');
                }
            }
            
            // Second pass: extract line items
            currentInvoiceNum = null;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Track current invoice
                const invMatch = line.match(/Customs Invoice\s+(\d+)/);
                if (invMatch) {
                    currentInvoiceNum = invMatch[1];
                }
                
                // Parse line items - flexible regex for container units
                const lineMatch = line.match(/^(\d+)\s+([\w]+\.[\w.]+)\s+([\d.]+)\s+(\w+)\s*(?:\([^\)]+\))?\s+x\s+([\d.]+)\s+(\w+)\s+([\d,]+\.?\d*)\s+\w+\s+([\d.]+)\s+USD\/(\w+)\s+([\d,]+\.?\d*)$/);
                
                if (lineMatch && currentInvoiceNum) {
                    const pos = lineMatch[1];
                    const productCode = lineMatch[2];
                    const partNumber = productCode.split('.')[0];
                    const containerQty = lineMatch[3];
                    const containerUnit = lineMatch[4];
                    const perQty = lineMatch[5];
                    const volumeUnit = lineMatch[6];
                    const totalQty = lineMatch[7].replace(/,/g, '');
                    const unitPrice = lineMatch[8];
                    const priceUnit = lineMatch[9];
                    const lineTotal = lineMatch[10].replace(/,/g, '');
                    
                    // Determine correct quantity based on price unit
                    const containerUnits = ['CN', 'CAT', 'PC', 'can', 'bucket', 'barrel', 'canister', 'pail', 'tin', 'cartridge', 'carton', 'piece'];
                    let quantity, unit;
                    
                    if (containerUnits.some(u => priceUnit.toUpperCase() === u.toUpperCase())) {
                        quantity = containerQty;
                        unit = priceUnit;
                    } else {
                        quantity = totalQty;
                        unit = priceUnit;
                    }
                    
                    // Look for net weight and country
                    let netWeight = '';
                    let country = '';
                    for (let j = i + 1; j < Math.min(i + 30, lines.length); j++) {
                        const weightMatch = lines[j].match(/([\d.]+)\s+L\s+([\d,]+\.?\d*)\s+L/);
                        if (weightMatch && !netWeight) {
                            netWeight = weightMatch[2].replace(/,/g, '');
                        }
                        
                        const countryMatch = lines[j].match(/Country of origin:\s+([^\n]+)/);
                        if (countryMatch) {
                            const countryStr = countryMatch[1].toLowerCase();
                            if (countryStr.includes('germany')) country = 'DE';
                            else if (countryStr.includes('netherlands')) country = 'NL';
                            else if (countryStr.includes('japan')) country = 'JP';
                            else if (countryStr.includes('slovenia')) country = 'SI';
                            else if (countryStr.includes('mozambique')) country = 'MZ';
                            else if (countryStr.includes('china')) country = 'CN';
                            break;
                        }
                    }
                    
                    const invData = invoiceData[currentInvoiceNum] || {};
                    allData.push({
                        invoice_number: currentInvoiceNum,
                        invoice_date: invData.date || '',
                        invoice_total: invData.total || '',
                        supplier: invData.supplier || '',
                        position: pos,
                        part_number: partNumber,
                        quantity: quantity,
                        unit: unit,
                        unit_price: unitPrice,
                        line_total: lineTotal,
                        net_weight: netWeight,
                        country_of_origin: country
                    });
                }
            }
            
            if (allData.length === 0) {
                showAlert('No line items found. Please make sure this is a Mankiewicz customs invoice PDF.', 'error');
            } else {
                initEditor();
            }
        }
        
        function initEditor() {
            populateInvoiceDropdown();
            document.getElementById('invoiceSelect').addEventListener('change', handleInvoiceChange);
            document.getElementById('invoiceDateInput').addEventListener('change', updateInvoiceMetadata);
            document.getElementById('supplierInput').addEventListener('change', updateInvoiceMetadata);
            document.getElementById('invoiceTotalInput').addEventListener('change', updateInvoiceMetadata);
            loadInvoiceData();
        }
        
        function populateInvoiceDropdown() {
            const invoices = [...new Set(allData.map(d => d.invoice_number))].sort();
            const select = document.getElementById('invoiceSelect');
            select.innerHTML = '<option value="">All Invoices</option>';
            
            invoices.forEach(inv => {
                const option = document.createElement('option');
                option.value = inv;
                option.textContent = `Invoice ${inv}`;
                select.appendChild(option);
            });
        }
        
        function handleInvoiceChange(e) {
            currentInvoice = e.target.value;
            loadInvoiceData();
        }
        
        function updateInvoiceMetadata() {
            if (!currentInvoice) {
                showAlert('Please select a specific invoice first', 'error');
                return;
            }
            
            const newDate = document.getElementById('invoiceDateInput').value;
            const newSupplier = document.getElementById('supplierInput').value;
            const newTotal = document.getElementById('invoiceTotalInput').value;
            
            allData.forEach(item => {
                if (item.invoice_number === currentInvoice) {
                    if (newDate) item.invoice_date = newDate;
                    if (newSupplier) item.supplier = newSupplier;
                    if (newTotal) item.invoice_total = newTotal;
                }
            });
            
            loadInvoiceData();
            showAlert('Invoice metadata updated', 'success');
        }
        
        function loadInvoiceData() {
            const items = currentInvoice ? allData.filter(d => d.invoice_number === currentInvoice) : allData;
            
            if (items.length === 0) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No data found</td></tr>';
                return;
            }
            
            const invoiceInfo = items[0];
            document.getElementById('statInvoice').textContent = currentInvoice || 'All';
            document.getElementById('invoiceDateInput').value = invoiceInfo.invoice_date || '';
            document.getElementById('supplierInput').value = invoiceInfo.supplier || '';
            document.getElementById('invoiceTotalInput').value = invoiceInfo.invoice_total || '';
            
            renderTable(items);
            updateValidation();
        }
        
        function renderTable(items) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            items.forEach((item, index) => {
                const tr = createTableRow(item, index);
                tbody.appendChild(tr);
            });
        }
        
        function createTableRow(item, index) {
            const tr = document.createElement('tr');
            const globalIndex = allData.indexOf(item);
            
            const quantity = parseFloat(item.quantity) || 0;
            const unitPrice = parseFloat(item.unit_price) || 0;
            const calcTotal = (quantity * unitPrice).toFixed(2);
            const lineTotal = parseFloat(item.line_total || 0).toFixed(2);
            const isError = Math.abs(calcTotal - lineTotal) > 0.02;
            
            tr.innerHTML = `
                <td><input type="text" value="${item.position || ''}" data-index="${globalIndex}" data-field="position"></td>
                <td><input type="text" value="${item.part_number || ''}" data-index="${globalIndex}" data-field="part_number"></td>
                <td><input type="number" step="any" value="${item.quantity || ''}" data-index="${globalIndex}" data-field="quantity"></td>
                <td><input type="text" value="${item.unit || ''}" data-index="${globalIndex}" data-field="unit"></td>
                <td><input type="number" step="any" value="${item.unit_price || ''}" data-index="${globalIndex}" data-field="unit_price"></td>
                <td class="${isError ? 'error-cell' : ''}"><input type="number" step="any" value="${item.line_total || ''}" data-index="${globalIndex}" data-field="line_total"></td>
                <td class="readonly">$${calcTotal}</td>
                <td><input type="number" step="any" value="${item.net_weight || ''}" data-index="${globalIndex}" data-field="net_weight"></td>
                <td><input type="text" value="${item.country_of_origin || ''}" data-index="${globalIndex}" data-field="country_of_origin" maxlength="2"></td>
                <td class="actions-cell">
                    <button class="btn-warning" onclick="insertRowBelow(${globalIndex})">Insert Below</button>
                    <button class="btn-danger" onclick="deleteRow(${globalIndex})">Delete</button>
                </td>
            `;
            
            tr.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', function() {
                    const idx = parseInt(this.dataset.index);
                    const field = this.dataset.field;
                    if (allData[idx]) {
                        allData[idx][field] = this.value;
                        loadInvoiceData();
                    }
                });
            });
            
            return tr;
        }
        
        function insertRowBelow(index) {
            const currentItem = allData[index];
            const newItem = {
                invoice_number: currentItem.invoice_number,
                invoice_date: currentItem.invoice_date || '',
                invoice_total: currentItem.invoice_total || '',
                supplier: currentItem.supplier || '',
                position: '',
                part_number: '',
                quantity: '0',
                unit: '',
                unit_price: '0',
                line_total: '0',
                net_weight: '',
                country_of_origin: ''
            };
            
            allData.splice(index + 1, 0, newItem);
            loadInvoiceData();
            showAlert('Row inserted', 'success');
        }
        
        function deleteRow(index) {
            if (!confirm('Delete this line item?')) return;
            allData.splice(index, 1);
            loadInvoiceData();
            showAlert('Row deleted', 'success');
        }
        
        function updateValidation() {
            const items = currentInvoice ? allData.filter(d => d.invoice_number === currentInvoice) : allData;
            if (items.length === 0) return;
            
            const invoiceTotal = parseFloat(items[0].invoice_total) || 0;
            const lineItemsSum = items.reduce((sum, item) => sum + (parseFloat(item.line_total) || 0), 0);
            const difference = Math.abs(invoiceTotal - lineItemsSum);
            
            document.getElementById('statSum').textContent = '$' + lineItemsSum.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('statDiff').textContent = '$' + difference.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            const diffElement = document.getElementById('statDiff');
            if (difference < 0.02) {
                diffElement.classList.remove('error');
                diffElement.classList.add('success');
            } else {
                diffElement.classList.remove('success');
                diffElement.classList.add('error');
            }
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            const headers = [
                'InvoiceNumber', 'InvoiceDate', 'InvoiceTotal', 'SupplierMID', 'SupplierName',
                'BuyerPartNumber', 'SupplierPartNumber', 'Quantity', 'UnitOfMeasure', 'Description',
                'UnitPrice', 'ItemTotal', 'CurrencyCode', 'ExchangeRate', 'CountryOfOrigin',
                'CountryOfExport', 'DateOfExport', 'PortOfLading', 'RelatedParty', 'PO_Number',
                'PO_Date', 'GrossWeight', 'GrossWeightUnit', 'NetWeight', 'TariffNumber',
                'TariffDescription', 'Quantity1', 'UnitOfMeasure1', 'Quantity2', 'UnitOfMeasure2',
                'Quantity3', 'UnitOfMeasure3', 'PrimarySPI', 'SecondarySPI', 'DeliverTo',
                'SoldTo', 'SecondaryTariffNumber'
            ];
            
            const rows = [headers];
            
            allData.forEach(item => {
                const row = new Array(37).fill('');
                row[0] = item.invoice_number;
                row[1] = item.invoice_date;
                row[2] = parseFloat(item.invoice_total) || '';
                row[3] = '';
                row[4] = item.supplier;
                row[5] = '';
                row[6] = item.part_number;
                row[7] = parseFloat(item.quantity) || '';
                row[8] = item.unit;
                row[9] = '';
                row[10] = parseFloat(item.unit_price) || '';
                row[11] = parseFloat(item.line_total) || '';
                row[12] = '';
                row[13] = '';
                row[14] = item.country_of_origin;
                row[23] = parseFloat(item.net_weight) || '';
                
                rows.push(row);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, 'Invoice Data');
            
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const fileName = currentFileName.replace('.pdf', '') || 'invoice';
            XLSX.writeFile(wb, `manki_${fileName}_${timestamp}.xlsx`);
            
            showAlert('Excel file exported successfully!', 'success');
        }
        
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
        
        function resetParser() {
            allData = [];
            currentInvoice = '';
            currentFileName = '';
            document.getElementById('editorScreen').style.display = 'none';
            document.getElementById('uploadScreen').style.display = 'flex';
            document.getElementById('fileInput').value = '';
        }
    </script>
</body>
</html>
